{% extends "base.html" %}

{% block title %}Scoring Config - Coach Dashboard{% endblock %}

{% block extra_css %}
<style>
.config-section {
    background: #f9f9f9;
    border: 1px solid #ddd;
    border-radius: 8px;
    padding: 1.5rem;
    margin-bottom: 2rem;
}
.config-section h3 {
    margin-top: 0;
    color: #333;
    border-bottom: 2px solid #0066cc;
    padding-bottom: 0.5rem;
}
.config-group {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1.5rem;
}
.config-group.full {
    grid-template-columns: 1fr;
}
.warning {
    background: #fff3e0;
    color: #e65100;
    padding: 1rem;
    border-radius: 5px;
    margin-bottom: 1rem;
}
.info-box {
    background: #e7f3ff;
    color: #0066cc;
    padding: 1rem;
    border-radius: 5px;
    margin-bottom: 1rem;
}
.button-group {
    display: flex;
    gap: 0.5rem;
    margin-top: 2rem;
}
</style>
{% endblock %}

{% block content %}
<h2>Scoring Configuration</h2>

{% if message %}
<div class="success">{{ message }}</div>
{% endif %}

{% if error %}
<div class="error">{{ error }}</div>
{% endif %}

<div class="warning">
    <strong>‚ö†Ô∏è Warning:</strong> Changes to scoring rules will affect all future score calculations.
    Past results are NOT recalculated. Make sure you understand the impact before saving.
</div>

<form method="POST" action="/coach/config">
    
    <!-- Timing Penalties -->
    <div class="config-section">
        <h3>‚è±Ô∏è Timing Penalties</h3>
        <p style="color: #666; margin-bottom: 1rem;">Points deducted for timing deviations</p>
        <div class="config-group full">
            <div class="form-group">
                <label for="timing_penalty_per_second">Points Per Second Off:</label>
                <input type="number" id="timing_penalty_per_second" name="timing_penalty_per_second" 
                       value="{{ config.timing_penalty_per_second }}" step="0.1" min="0" required>
                <small style="color: #666;">Points deducted for each second deviation from planned time</small>
            </div>
        </div>
    </div>
    
    <!-- Off-Course Penalties -->
    <div class="config-section">
        <h3>üõ´ Off-Course Penalties</h3>
        <p style="color: #666; margin-bottom: 1rem;">Distance-based penalties for deviating from course</p>
        <div class="config-group">
            <div class="form-group">
                <label for="off_course_max_no_penalty">Max No-Penalty Distance (NM):</label>
                <input type="number" id="off_course_max_no_penalty" name="off_course_max_no_penalty" 
                       value="{{ config.off_course.max_no_penalty_nm }}" step="0.01" min="0" required>
                <small style="color: #666;">Distance allowed with zero penalty</small>
            </div>
            <div class="form-group">
                <label for="off_course_max_penalty_distance">Max Penalty Distance (NM):</label>
                <input type="number" id="off_course_max_penalty_distance" name="off_course_max_penalty_distance" 
                       value="{{ config.off_course.max_penalty_distance_nm }}" step="0.1" min="0" required>
                <small style="color: #666;">Distance at which max penalty applies</small>
            </div>
            <div class="form-group full">
                <label for="off_course_max_penalty_points">Maximum Off-Course Points:</label>
                <input type="number" id="off_course_max_penalty_points" name="off_course_max_penalty_points" 
                       value="{{ config.off_course.max_penalty_points }}" step="1" min="0" required>
                <small style="color: #666;">Maximum points for being off course</small>
            </div>
        </div>
    </div>
    
    <!-- Fuel Penalties -->
    <div class="config-section">
        <h3>‚õΩ Fuel Penalties</h3>
        <p style="color: #666; margin-bottom: 1rem;">Penalties for fuel estimation errors</p>
        <div class="config-group">
            <div class="form-group">
                <label for="fuel_over_estimate_multiplier">Over-Estimate Multiplier:</label>
                <input type="number" id="fuel_over_estimate_multiplier" name="fuel_over_estimate_multiplier" 
                       value="{{ config.fuel_burn.over_estimate_multiplier }}" step="1" min="0" required>
                <small style="color: #666;">Points per gallon overestimated</small>
            </div>
            <div class="form-group">
                <label for="fuel_under_estimate_threshold">Under-Estimate Threshold:</label>
                <input type="number" id="fuel_under_estimate_threshold" name="fuel_under_estimate_threshold" 
                       value="{{ config.fuel_burn.under_estimate_threshold }}" step="0.01" min="0" required>
                <small style="color: #666;">Threshold for under-estimation penalty</small>
            </div>
            <div class="form-group full">
                <label for="fuel_under_estimate_multiplier">Under-Estimate Multiplier:</label>
                <input type="number" id="fuel_under_estimate_multiplier" name="fuel_under_estimate_multiplier" 
                       value="{{ config.fuel_burn.under_estimate_multiplier }}" step="1" min="0" required>
                <small style="color: #666;">Points per gallon underestimated</small>
            </div>
        </div>
    </div>
    
    <!-- Secrets Scoring -->
    <div class="config-section">
        <h3>üîê Secrets Scoring</h3>
        <p style="color: #666; margin-bottom: 1rem;">Penalties for missing secret locations</p>
        <div class="config-group">
            <div class="form-group">
                <label for="secrets_checkpoint_penalty">Checkpoint Secret Points:</label>
                <input type="number" id="secrets_checkpoint_penalty" name="secrets_checkpoint_penalty" 
                       value="{{ config.secrets.checkpoint_penalty }}" step="1" min="0" required>
                <small style="color: #666;">Points per missed checkpoint secret</small>
            </div>
            <div class="form-group">
                <label for="secrets_enroute_penalty">En-Route Secret Points:</label>
                <input type="number" id="secrets_enroute_penalty" name="secrets_enroute_penalty" 
                       value="{{ config.secrets.enroute_penalty }}" step="1" min="0" required>
                <small style="color: #666;">Points per missed en-route secret</small>
            </div>
            <div class="form-group full">
                <label for="secrets_max_distance">Max Detection Distance (miles):</label>
                <input type="number" id="secrets_max_distance" name="secrets_max_distance" 
                       value="{{ config.secrets.max_distance_miles }}" step="0.1" min="0" required>
                <small style="color: #666;">How close crew must be to find a secret</small>
            </div>
        </div>
    </div>
    
    <div class="button-group">
        <button type="submit">Save Configuration</button>
        <button type="button" onclick="window.location.href='/coach'">Cancel</button>
    </div>
</form>

<!-- Email Configuration Section -->
<form method="POST" action="/coach/config/email">
    <div class="config-section">
        <h3>üìß Email Configuration (SMTP)</h3>
        <p style="color: #666; margin-bottom: 1rem;">Settings for sending pre-flight and results emails</p>
        <div class="config-group">
            <div class="form-group">
                <label for="smtp_host">SMTP Host:</label>
                <input type="text" id="smtp_host" name="smtp_host" 
                       value="{{ email_config.get('smtp_host', 'smtp.zoho.com') }}" required>
                <small style="color: #666;">e.g., smtp.zoho.com, smtp.gmail.com</small>
            </div>
            <div class="form-group">
                <label for="smtp_port">SMTP Port:</label>
                <input type="number" id="smtp_port" name="smtp_port" 
                       value="{{ email_config.get('smtp_port', 587) }}" min="1" max="65535" required>
                <small style="color: #666;">Common: 587 (TLS), 465 (SSL)</small>
            </div>
            <div class="form-group">
                <label for="from_email">From Email Address:</label>
                <input type="email" id="from_email" name="from_email" 
                       value="{{ email_config.get('sender_email', '') }}" required>
                <small style="color: #666;">Email address emails will be sent from</small>
            </div>
            <div class="form-group">
                <label for="from_name">From Name:</label>
                <input type="text" id="from_name" name="from_name" 
                       value="{{ email_config.get('sender_name', 'NAV Scoring') }}" required>
                <small style="color: #666;">Display name in email "From" field</small>
            </div>
            <div class="form-group full">
                <label for="smtp_username">SMTP Username:</label>
                <input type="text" id="smtp_username" name="smtp_username" 
                       value="{{ email_config.get('smtp_username', '') }}" required>
                <small style="color: #666;">Usually your email address</small>
            </div>
            <div class="form-group full">
                <label for="smtp_password">SMTP Password:</label>
                <input type="password" id="smtp_password" name="smtp_password" 
                       placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" value="">
                <small style="color: #666;">Leave blank to keep existing password. Use app-specific password if 2FA is enabled.</small>
            </div>
        </div>
        <div class="button-group" style="margin-top: 1rem;">
            <button type="submit">Save Email Configuration</button>
        </div>
    </div>
</form>

<div class="info-box" style="margin-top: 2rem;">
    <strong>‚ÑπÔ∏è How Scoring Works:</strong>
    <ul style="margin: 0.5rem 0 0 1.5rem; line-height: 1.8;">
        <li><strong>Timing:</strong> Each leg's deviation multiplied by timing penalty</li>
        <li><strong>Off-Course:</strong> Distance penalties scale up to max at threshold</li>
        <li><strong>Fuel:</strong> Separate penalties for over/under estimation</li>
        <li><strong>Secrets:</strong> Fixed points for each missed location</li>
    </ul>
</div>

{% endblock %}
