{% extends "base.html" %}

{% block title %}System Config - Coach Dashboard{% endblock %}

{% block navbar %}
<div class="navbar">
    <div class="navbar-brand">
        <button class="hamburger" id="hamburgerBtn">‚ò∞</button>
        <h1>Coach Dashboard - System Config <span style="background: #0066cc; color: white; padding: 0.25rem 0.5rem; border-radius: 5px; font-size: 0.8rem;">ADMIN</span></h1>
    </div>
    <div class="navbar-links" id="navbarLinks">
        <a href="/coach">Dashboard</a>
        <a href="/coach/results">Results</a>
        <a href="/coach/members">Users</a>
        <a href="/coach/pairings">Pairings</a>
        <a href="/coach/navs">NAVs</a>
        <a href="/logout">Logout</a>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
.config-section {
    background: #f9f9f9;
    border: 1px solid #ddd;
    border-radius: 8px;
    padding: 1.5rem;
    margin-bottom: 2rem;
}
.config-section h3 {
    margin-top: 0;
    color: #333;
    border-bottom: 2px solid #0066cc;
    padding-bottom: 0.5rem;
}
.config-group {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1.5rem;
}
.config-group.full {
    grid-template-columns: 1fr;
}
.warning {
    background: #fff3e0;
    color: #e65100;
    padding: 1rem;
    border-radius: 5px;
    margin-bottom: 1rem;
}
.info-box {
    background: #e7f3ff;
    color: #0066cc;
    padding: 1rem;
    border-radius: 5px;
    margin-bottom: 1rem;
}
.button-group {
    display: flex;
    gap: 0.5rem;
    margin-top: 2rem;
}
</style>
{% endblock %}

{% block content %}
<h2>System Configuration</h2>

{% if message %}
<div class="success">{{ message }}</div>
{% endif %}

{% if error %}
<div class="error">{{ error }}</div>
{% endif %}

<div class="warning">
    <strong>‚ö†Ô∏è Warning:</strong> Changes to scoring rules will affect all future score calculations.
    Past results are NOT recalculated. Make sure you understand the impact before saving.
</div>

<form method="POST" action="/coach/config">
    
    <!-- Timing Penalties -->
    <div class="config-section">
        <h3>‚è±Ô∏è Timing Penalties</h3>
        <p style="color: #666; margin-bottom: 1rem;">Points deducted for timing deviations</p>
        <div class="config-group full">
            <div class="form-group">
                <label for="timing_penalty_per_second">Points Per Second Off:</label>
                <input type="number" id="timing_penalty_per_second" name="timing_penalty_per_second" 
                       value="{{ config.timing_penalty_per_second }}" step="0.1" min="0" required>
                <small style="color: #666;">Points deducted for each second deviation from planned time</small>
            </div>
        </div>
    </div>
    
    <!-- Off-Course Penalties -->
    <div class="config-section">
        <h3>üõ´ Off-Course Penalties</h3>
        <p style="color: #666; margin-bottom: 1rem;">Distance-based penalties for deviating from course</p>
        <div class="config-group">
            <div class="form-group">
                <label for="off_course_max_no_penalty">Max No-Penalty Distance (NM):</label>
                <input type="number" id="off_course_max_no_penalty" name="off_course_max_no_penalty" 
                       value="{{ config.off_course.max_no_penalty_nm }}" step="0.01" min="0" required>
                <small style="color: #666;">Distance allowed with zero penalty</small>
            </div>
            <div class="form-group">
                <label for="off_course_max_penalty_distance">Max Penalty Distance (NM):</label>
                <input type="number" id="off_course_max_penalty_distance" name="off_course_max_penalty_distance" 
                       value="{{ config.off_course.max_penalty_distance_nm }}" step="0.1" min="0" required>
                <small style="color: #666;">Distance at which max penalty applies</small>
            </div>
            <div class="form-group full">
                <label for="off_course_max_penalty_points">Maximum Off-Course Points:</label>
                <input type="number" id="off_course_max_penalty_points" name="off_course_max_penalty_points" 
                       value="{{ config.off_course.max_penalty_points }}" step="1" min="0" required>
                <small style="color: #666;">Maximum points for being off course</small>
            </div>
        </div>
    </div>
    
    <!-- Fuel Penalties -->
    <div class="config-section">
        <h3>‚õΩ Fuel Penalties</h3>
        <p style="color: #666; margin-bottom: 1rem;">Penalties for fuel estimation errors</p>
        <div class="config-group">
            <div class="form-group">
                <label for="fuel_over_estimate_multiplier">Over-Estimate Multiplier:</label>
                <input type="number" id="fuel_over_estimate_multiplier" name="fuel_over_estimate_multiplier" 
                       value="{{ config.fuel_burn.over_estimate_multiplier }}" step="1" min="0" required>
                <small style="color: #666;">Points per gallon overestimated</small>
            </div>
            <div class="form-group">
                <label for="fuel_under_estimate_threshold">Under-Estimate Threshold:</label>
                <input type="number" id="fuel_under_estimate_threshold" name="fuel_under_estimate_threshold" 
                       value="{{ config.fuel_burn.under_estimate_threshold }}" step="0.01" min="0" required>
                <small style="color: #666;">Threshold for under-estimation penalty</small>
            </div>
            <div class="form-group full">
                <label for="fuel_under_estimate_multiplier">Under-Estimate Multiplier:</label>
                <input type="number" id="fuel_under_estimate_multiplier" name="fuel_under_estimate_multiplier" 
                       value="{{ config.fuel_burn.under_estimate_multiplier }}" step="1" min="0" required>
                <small style="color: #666;">Points per gallon underestimated</small>
            </div>
        </div>
    </div>
    
    <!-- Secrets Scoring -->
    <div class="config-section">
        <h3>üîê Secrets Scoring</h3>
        <p style="color: #666; margin-bottom: 1rem;">Penalties for missing secret locations</p>
        <div class="config-group">
            <div class="form-group">
                <label for="secrets_checkpoint_penalty">Checkpoint Secret Points:</label>
                <input type="number" id="secrets_checkpoint_penalty" name="secrets_checkpoint_penalty" 
                       value="{{ config.secrets.checkpoint_penalty }}" step="1" min="0" required>
                <small style="color: #666;">Points per missed checkpoint secret</small>
            </div>
            <div class="form-group">
                <label for="secrets_enroute_penalty">En-Route Secret Points:</label>
                <input type="number" id="secrets_enroute_penalty" name="secrets_enroute_penalty" 
                       value="{{ config.secrets.enroute_penalty }}" step="1" min="0" required>
                <small style="color: #666;">Points per missed en-route secret</small>
            </div>
            <div class="form-group full">
                <label for="secrets_max_distance">Max Detection Distance (miles):</label>
                <input type="number" id="secrets_max_distance" name="secrets_max_distance" 
                       value="{{ config.secrets.max_distance_miles }}" step="0.1" min="0" required>
                <small style="color: #666;">How close crew must be to find a secret</small>
            </div>
        </div>
    </div>
    
    <div class="button-group">
        <button type="submit">Save Configuration</button>
        <button type="button" onclick="window.location.href='/coach'">Cancel</button>
    </div>
</form>

<!-- Email Configuration Section -->
<form method="POST" action="/coach/config/email">
    <div class="config-section">
        <h3>üìß Email Configuration (SMTP)</h3>
        <p style="color: #666; margin-bottom: 1rem;">Settings for sending pre-flight and results emails</p>
        <div class="config-group">
            <div class="form-group">
                <label for="smtp_host">SMTP Host:</label>
                <input type="text" id="smtp_host" name="smtp_host" 
                       value="{{ email_config.get('smtp_host', 'smtp.zoho.com') }}" required>
                <small style="color: #666;">e.g., smtp.zoho.com, smtp.gmail.com</small>
            </div>
            <div class="form-group">
                <label for="smtp_port">SMTP Port:</label>
                <input type="number" id="smtp_port" name="smtp_port" 
                       value="{{ email_config.get('smtp_port', 587) }}" min="1" max="65535" required>
                <small style="color: #666;">Common: 587 (TLS), 465 (SSL)</small>
            </div>
            <div class="form-group">
                <label for="from_email">From Email Address:</label>
                <input type="email" id="from_email" name="from_email" 
                       value="{{ email_config.get('sender_email', '') }}" required>
                <small style="color: #666;">Email address emails will be sent from</small>
            </div>
            <div class="form-group">
                <label for="from_name">From Name:</label>
                <input type="text" id="from_name" name="from_name" 
                       value="{{ email_config.get('sender_name', 'NAV Scoring') }}" required>
                <small style="color: #666;">Display name in email "From" field</small>
            </div>
            <div class="form-group full">
                <label for="smtp_username">SMTP Username:</label>
                <input type="text" id="smtp_username" name="smtp_username" 
                       value="{{ email_config.get('smtp_username', '') }}" required>
                <small style="color: #666;">Usually your email address</small>
            </div>
            <div class="form-group full">
                <label for="smtp_password">SMTP Password:</label>
                <input type="password" id="smtp_password" name="smtp_password" 
                       placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" value="">
                <small style="color: #666;">Leave blank to keep existing password. Use app-specific password if 2FA is enabled.</small>
            </div>
        </div>
        
        <!-- Test SMTP Connection Section -->
        <div style="margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid #ddd;">
            <h4 style="color: #333; margin-top: 0;">Test SMTP Connection</h4>
            <p style="color: #666; margin-bottom: 1rem;">Click the button below to test your SMTP configuration. A test email will be sent to your configured email address.</p>
            <div style="display: flex; gap: 0.5rem; align-items: center;">
                <button type="button" id="testSmtpBtn" class="btn-secondary" style="background-color: #666;">
                    üîß Test SMTP Connection
                </button>
                <span id="testSmtpLoading" style="display: none; color: #666;">Testing...</span>
            </div>
            <div id="testSmtpResult" style="margin-top: 1rem; display: none; padding: 1rem; border-radius: 5px;">
                <span id="testSmtpMessage"></span>
            </div>
        </div>
        
        <div class="button-group" style="margin-top: 1rem;">
            <button type="submit">Save Email Configuration</button>
        </div>
    </div>
</form>

<!-- Backup Configuration Form -->
<form method="POST" action="/coach/config/backup">
    <div class="config-section">
        <h3>üíæ Automated Backup Configuration</h3>
        <p style="color: #666; margin-bottom: 1rem;">Configure automatic database backups and retention policies</p>
        
        <div class="config-group full">
            <div class="form-group">
                <label for="backup_enabled" style="display: flex; align-items: center; gap: 0.5rem;">
                    <input type="checkbox" id="backup_enabled" name="backup_enabled" 
                           {% if backup_config.enabled %}checked{% endif %}>
                    <span>Enable Automated Backups</span>
                </label>
                <small style="color: #666; margin-left: 1.5rem;">Enable or disable automatic database backups</small>
            </div>
        </div>
        
        <div class="config-group">
            <div class="form-group">
                <label for="backup_frequency_hours">Backup Frequency (hours):</label>
                <input type="number" id="backup_frequency_hours" name="backup_frequency_hours" 
                       value="{{ backup_config.frequency_hours }}" min="1" max="720" required>
                <small style="color: #666;">How often to run backups (1-720 hours)</small>
            </div>
            <div class="form-group">
                <label for="backup_retention_days">Retention Period (days):</label>
                <input type="number" id="backup_retention_days" name="backup_retention_days" 
                       value="{{ backup_config.retention_days }}" min="1" max="365" required>
                <small style="color: #666;">Keep backups for this many days</small>
            </div>
        </div>
        
        <div class="config-group">
            <div class="form-group">
                <label for="backup_max_backups">Max Backups to Keep:</label>
                <input type="number" id="backup_max_backups" name="backup_max_backups" 
                       value="{{ backup_config.max_backups }}" min="1" max="1000" required>
                <small style="color: #666;">Keep only the most recent backups</small>
            </div>
            <div class="form-group">
                <label for="backup_path">Backup Directory Path:</label>
                <input type="text" id="backup_path" name="backup_path" 
                       value="{{ backup_config.backup_path }}" required>
                <small style="color: #666;">Where to store backup files</small>
            </div>
        </div>
        
        <!-- Backup Status Section -->
        <div style="margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid #ddd;">
            <h4 style="color: #333; margin-top: 0;">Backup Status</h4>
            <div class="config-group full">
                <div style="padding: 1rem; background: white; border: 1px solid #ddd; border-radius: 5px;">
                    <p style="margin: 0.5rem 0;">
                        <strong>Last Backup:</strong> 
                        <span id="lastBackupTime">{% if backup_status.last_backup %}{{ backup_status.last_backup }}{% else %}Never{% endif %}</span>
                    </p>
                    <p style="margin: 0.5rem 0;">
                        <strong>Next Scheduled:</strong> 
                        <span id="nextBackupTime">{% if backup_status.next_scheduled %}{{ backup_status.next_scheduled }}{% else %}Not scheduled{% endif %}</span>
                    </p>
                    <p style="margin: 0.5rem 0;">
                        <strong>Total Backups:</strong> 
                        <span id="totalBackups">{{ backup_status.total_backups }}</span>
                    </p>
                </div>
            </div>
        </div>
        
        <!-- Manual Backup Section -->
        <div style="margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid #ddd;">
            <h4 style="color: #333; margin-top: 0;">Manual Backup</h4>
            <p style="color: #666; margin-bottom: 1rem;">Trigger an immediate backup of the database</p>
            <div style="display: flex; gap: 0.5rem; align-items: center;">
                <button type="button" id="runBackupBtn" class="btn-backup" style="background-color: #28a745;">
                    üîÑ Run Backup Now
                </button>
                <span id="backupLoading" style="display: none; color: #666;">Backing up...</span>
            </div>
            <div id="backupResult" style="margin-top: 1rem; display: none; padding: 1rem; border-radius: 5px;">
                <span id="backupMessage"></span>
            </div>
        </div>
        
        <div class="button-group" style="margin-top: 2rem;">
            <button type="submit">Save Backup Configuration</button>
        </div>
    </div>
</form>

<style>
.btn-secondary {
    background-color: #666;
    color: white;
    padding: 0.75rem 1.5rem;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    font-size: 1rem;
    transition: background-color 0.3s ease;
}

.btn-secondary:hover {
    background-color: #555;
}

.test-result-success {
    background-color: #d4edda;
    color: #155724;
    border: 1px solid #c3e6cb;
}

.test-result-error {
    background-color: #f8d7da;
    color: #721c24;
    border: 1px solid #f5c6cb;
}

.btn-backup {
    background-color: #28a745;
    color: white;
    padding: 0.75rem 1.5rem;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    font-size: 1rem;
    transition: background-color 0.3s ease;
}

.btn-backup:hover {
    background-color: #218838;
}

.btn-backup:disabled {
    background-color: #ccc;
    cursor: not-allowed;
}

.backup-result-success {
    background-color: #d4edda;
    color: #155724;
    border: 1px solid #c3e6cb;
}

.backup-result-error {
    background-color: #f8d7da;
    color: #721c24;
    border: 1px solid #f5c6cb;
}
</style>

<script>
document.getElementById('testSmtpBtn').addEventListener('click', async function(e) {
    e.preventDefault();
    
    const btn = document.getElementById('testSmtpBtn');
    const loading = document.getElementById('testSmtpLoading');
    const result = document.getElementById('testSmtpResult');
    const message = document.getElementById('testSmtpMessage');
    
    // Show loading state
    btn.disabled = true;
    loading.style.display = 'inline';
    result.style.display = 'none';
    
    try {
        const response = await fetch('/coach/test_smtp', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest'
            }
        });
        
        const data = await response.json();
        
        // Display result
        result.style.display = 'block';
        if (data.success) {
            result.className = 'test-result-success';
            message.innerHTML = '‚úÖ ' + data.message;
        } else {
            result.className = 'test-result-error';
            message.innerHTML = '‚ùå ' + data.message;
        }
    } catch (error) {
        result.style.display = 'block';
        result.className = 'test-result-error';
        message.innerHTML = '‚ùå Error: ' + error.message;
    } finally {
        btn.disabled = false;
        loading.style.display = 'none';
    }
});

// Manual Backup Button
document.getElementById('runBackupBtn').addEventListener('click', async function(e) {
    e.preventDefault();
    
    const btn = document.getElementById('runBackupBtn');
    const loading = document.getElementById('backupLoading');
    const result = document.getElementById('backupResult');
    const message = document.getElementById('backupMessage');
    
    // Show loading state
    btn.disabled = true;
    loading.style.display = 'inline';
    result.style.display = 'none';
    
    try {
        const response = await fetch('/coach/backup/run', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest'
            }
        });
        
        const data = await response.json();
        
        // Display result
        result.style.display = 'block';
        if (data.success) {
            result.className = 'backup-result-success';
            message.innerHTML = '‚úÖ ' + data.message + (data.backup_file ? '<br>File: ' + data.backup_file : '');
            // Update status
            if (data.last_backup) {
                document.getElementById('lastBackupTime').textContent = data.last_backup;
            }
            if (data.total_backups) {
                document.getElementById('totalBackups').textContent = data.total_backups;
            }
        } else {
            result.className = 'backup-result-error';
            message.innerHTML = '‚ùå ' + data.message;
        }
    } catch (error) {
        result.style.display = 'block';
        result.className = 'backup-result-error';
        message.innerHTML = '‚ùå Error: ' + error.message;
    } finally {
        btn.disabled = false;
        loading.style.display = 'none';
    }
});
</script>

<div class="info-box" style="margin-top: 2rem;">
    <strong>‚ÑπÔ∏è How Scoring Works:</strong>
    <ul style="margin: 0.5rem 0 0 1.5rem; line-height: 1.8;">
        <li><strong>Timing:</strong> Each leg's deviation multiplied by timing penalty</li>
        <li><strong>Off-Course:</strong> Distance penalties scale up to max at threshold</li>
        <li><strong>Fuel:</strong> Separate penalties for over/under estimation</li>
        <li><strong>Secrets:</strong> Fixed points for each missed location</li>
    </ul>
</div>

{% endblock %}
