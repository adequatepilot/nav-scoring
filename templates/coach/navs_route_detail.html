{% extends "base.html" %}

{% block title %}{{ nav.name }} - Checkpoints{% endblock %}

{% block navbar %}
<div class="navbar">
    <div class="navbar-brand">
        <button class="hamburger" id="hamburgerBtn">‚ò∞</button>
        <h1>{{ nav.name }} - Checkpoints</h1>
    </div>
    <div class="navbar-links" id="navbarLinks">
        <a href="/dashboard">Dashboard</a>
        <a href="/profile">Profile</a>
        <a href="/logout">Logout</a>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
.card {
    max-width: 1000px;
}
.header-section {
    background: linear-gradient(135deg, #8B0015 0%, #5D000F 100%);
    color: white;
    padding: 2rem;
    border-radius: 10px;
    margin-bottom: 2rem;
}
.header-section h2 {
    margin: 0;
    font-size: 2rem;
}
.header-section .airport {
    font-size: 1.1rem;
    opacity: 0.9;
    margin-top: 0.5rem;
}
.checkpoint-list {
    margin-top: 2rem;
}
.checkpoint-item {
    background: white;
    border: 2px solid #ddd;
    border-radius: 8px;
    padding: 1.25rem;
    margin-bottom: 1rem;
    display: grid;
    grid-template-columns: 60px 1fr 180px 180px auto;
    gap: 1.25rem;
    align-items: center;
    transition: all 0.2s;
}
.checkpoint-item:hover {
    border-color: #8B0015;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}
.drag-handle {
    display: none;
}
.sequence-num {
    font-weight: bold;
    color: #8B0015;
    font-size: 1.4rem;
    text-align: center;
}
.checkpoint-item input {
    width: 100%;
    padding: 0.75rem;
    border: 1px solid #ddd;
    border-radius: 4px;
    font-size: 1rem;
}
.checkpoint-item input:disabled {
    background: transparent;
    border-color: transparent;
    color: #333;
}
.checkpoint-item input[type="number"]:disabled {
    -moz-appearance: textfield;
}
.checkpoint-item input[type="number"]:disabled::-webkit-outer-spin-button,
.checkpoint-item input[type="number"]:disabled::-webkit-inner-spin-button {
    -webkit-appearance: none;
    margin: 0;
}
.action-buttons {
    display: flex;
    gap: 0.25rem;
    flex-wrap: wrap;
    justify-content: flex-end;
}
.btn-edit {
    background: #2196f3;
    color: white;
    border: none;
    padding: 0.6rem 1rem;
    border-radius: 4px;
    cursor: pointer;
    font-size: 0.85rem;
    font-weight: 500;
}
.btn-save {
    background: #4caf50;
    color: white;
    border: none;
    padding: 0.6rem 1rem;
    border-radius: 4px;
    cursor: pointer;
    font-size: 0.85rem;
    font-weight: 500;
}
.btn-cancel {
    background: #ff9800;
    color: white;
    border: none;
    padding: 0.6rem 1rem;
    border-radius: 4px;
    cursor: pointer;
    font-size: 0.85rem;
    font-weight: 500;
}
.btn-delete {
    background: #8B0015;
    color: white;
    border: none;
    padding: 0.6rem 1rem;
    border-radius: 4px;
    cursor: pointer;
    font-size: 0.85rem;
    font-weight: 500;
}
.btn-move {
    background: #666;
    color: white;
    border: none;
    padding: 0.6rem 0.8rem;
    border-radius: 4px;
    cursor: pointer;
    font-size: 0.85rem;
    font-weight: 600;
    min-width: 36px;
}
.btn-move:disabled {
    background: #ccc;
    cursor: not-allowed;
}
.add-checkpoint-btn {
    background: linear-gradient(135deg, #8B0015 0%, #5D000F 100%);
    color: white;
    border: none;
    padding: 1rem 2rem;
    border-radius: 10px;
    font-size: 1.1rem;
    font-weight: 600;
    cursor: pointer;
    width: 100%;
    margin-bottom: 2rem;
}
.add-checkpoint-btn:hover {
    transform: translateY(-2px);
}
.stats {
    background: #f5f5f5;
    padding: 1rem;
    border-radius: 8px;
    margin-bottom: 2rem;
    display: flex;
    justify-content: space-around;
}
.stat-item {
    text-align: center;
}
.stat-value {
    font-size: 2rem;
    font-weight: bold;
    color: #8B0015;
}
.stat-label {
    color: #666;
    font-size: 0.9rem;
}
</style>
{% endblock %}

{% block content %}
<div style="margin-bottom: 2rem;">
    <a href="/coach/navs/airport/{{ airport_id }}" style="display: inline-block; background: linear-gradient(135deg, #8B0015 0%, #5D000F 100%); color: white; padding: 0.75rem 1.5rem; border-radius: 5px; text-decoration: none; font-weight: 500; transition: transform 0.2s;" onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">‚Üê Back to {{ airport_code }}</a>
</div>

<div class="header-section">
    <h2>üìç {{ nav.name }}</h2>
    <div class="airport">{{ airport_code }}</div>
</div>

<div class="stats">
    <div class="stat-item">
        <div class="stat-value" id="checkpointCount">{{ checkpoints|length }}</div>
        <div class="stat-label">Checkpoints</div>
    </div>
</div>

<!-- PDF Packet Section -->
{% if is_admin %}
<div style="background: #f9f9f9; padding: 1.5rem; border-radius: 8px; border: 1px solid #e0e0e0; margin-bottom: 2rem;">
    <h3 style="margin-top: 0; margin-bottom: 1rem; font-size: 1.1rem; color: #333;">üìÑ NAV Packet PDF</h3>
    {% if nav.get('pdf_path') %}
    <div style="background: white; padding: 1rem; border-radius: 6px; border: 1px solid #ddd; margin-bottom: 1rem;">
        <p style="margin: 0 0 0.75rem 0; color: #666; font-size: 0.9rem;">
            <strong>Current PDF:</strong> <span id="current-pdf-name">{{ nav['pdf_path'].split('/')[-1] }}</span>
        </p>
        <div style="display: flex; gap: 0.5rem;">
            <a href="/nav-packets/{{ nav['pdf_path'].split('/')[-1] }}" target="_blank" style="background: #2196f3; color: white; padding: 0.6rem 1rem; text-decoration: none; border-radius: 4px; font-size: 0.85rem;">
                ‚¨áÔ∏è Download Current PDF
            </a>
            <button onclick="document.getElementById('pdf-upload-form').style.display = 'block'" style="background: #8B0015; color: white; border: none; padding: 0.6rem 1rem; border-radius: 4px; cursor: pointer; font-size: 0.85rem;">
                üîÑ Replace PDF
            </button>
            <button onclick="deletePdf({{ nav.id }})" style="background: #999; color: white; border: none; padding: 0.6rem 1rem; border-radius: 4px; cursor: pointer; font-size: 0.85rem;">
                üóëÔ∏è Remove PDF
            </button>
        </div>
    </div>
    {% else %}
    <p style="color: #666; margin: 0 0 1rem 0; font-size: 0.95rem;">No PDF uploaded yet. Upload one to provide students with the NAV packet.</p>
    {% endif %}
    
    <div id="pdf-upload-form" style="{% if nav.get('pdf_path') %}display: none;{% endif %} background: white; padding: 1rem; border-radius: 6px; border: 1px solid #ddd;">
        <form onsubmit="uploadPdf(event, {{ nav.id }})">
            <div style="margin-bottom: 1rem;">
                <label for="pdf-file" style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Select PDF File:</label>
                <input type="file" id="pdf-file" accept=".pdf" required style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;">
                <small style="color: #999; display: block; margin-top: 0.5rem;">Max 50MB. PDF format only.</small>
            </div>
            <div style="display: flex; gap: 0.5rem;">
                <button type="submit" style="background: linear-gradient(135deg, #8B0015 0%, #5D000F 100%); color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 4px; cursor: pointer; font-weight: 600;">
                    Upload PDF
                </button>
                <button type="button" onclick="cancelPdfUpload()" style="background: #ccc; color: #333; border: none; padding: 0.75rem 1.5rem; border-radius: 4px; cursor: pointer;">
                    Cancel
                </button>
            </div>
        </form>
    </div>
</div>
{% endif %}

{% if is_admin %}
<button class="add-checkpoint-btn" onclick="addCheckpoint()">‚ûï Add Checkpoint</button>
{% endif %}

<div class="checkpoint-list" id="checkpointList">
    {% for checkpoint in checkpoints %}
    <div class="checkpoint-item locked" data-id="{{ checkpoint.id }}" data-sequence="{{ checkpoint.sequence }}" draggable="false">
        <div class="drag-handle">‚ãÆ‚ãÆ</div>
        <div class="sequence-num">{{ checkpoint.sequence }}</div>
        <input type="text" class="checkpoint-name" value="{{ checkpoint.name }}" disabled>
        <input type="number" step="0.0000001" class="checkpoint-lat" value="{{ checkpoint.lat }}" disabled>
        <input type="number" step="0.0000001" class="checkpoint-lon" value="{{ checkpoint.lon }}" disabled>
        <div class="action-buttons">
            {% if is_admin %}
            <button class="btn-move" id="moveup-{{ checkpoint.id }}" onclick="moveCheckpointUp(this)" title="Move up">‚Üë</button>
            <button class="btn-move" id="movedown-{{ checkpoint.id }}" onclick="moveCheckpointDown(this)" title="Move down">‚Üì</button>
            <button class="btn-edit" onclick="editCheckpoint(this)">Edit</button>
            <button class="btn-save" onclick="saveCheckpoint(this)" style="display: none;">Save</button>
            <button class="btn-cancel" onclick="cancelEdit(this)" style="display: none;">Cancel</button>
            <button class="btn-delete" onclick="deleteCheckpoint({{ checkpoint.id }})">Delete</button>
            {% else %}
            <span style="color: #999; font-size: 0.9rem;">Read Only</span>
            {% endif %}
        </div>
    </div>
    {% endfor %}
</div>

{% if not checkpoints and not is_admin %}
<div class="info">No checkpoints configured for this NAV yet.</div>
{% endif %}

<script>
function addCheckpoint() {
    const list = document.getElementById('checkpointList');
    const count = list.children.length + 1;
    
    const item = document.createElement('div');
    item.className = 'checkpoint-item';
    item.dataset.id = 'new';
    item.dataset.sequence = count;
    item.innerHTML = `
        <div class="sequence-num">${count}</div>
        <input type="text" class="checkpoint-name" placeholder="Checkpoint name">
        <input type="number" step="0.0000001" class="checkpoint-lat" placeholder="Latitude">
        <input type="number" step="0.0000001" class="checkpoint-lon" placeholder="Longitude">
        <div class="action-buttons">
            <button class="btn-save" onclick="saveCheckpoint(this)">Save</button>
            <button class="btn-cancel" onclick="removeNewCheckpoint(this)">Cancel</button>
        </div>
    `;
    
    list.appendChild(item);
    item.querySelector('.checkpoint-name').focus();
    updateCheckpointCount();
}

function editCheckpoint(btn) {
    const item = btn.closest('.checkpoint-item');
    
    item.querySelectorAll('input').forEach(input => input.disabled = false);
    
    btn.style.display = 'none';
    item.querySelector('.btn-save').style.display = 'inline-block';
    item.querySelector('.btn-cancel').style.display = 'inline-block';
}

function cancelEdit(btn) {
    // Reload original values
    location.reload();
}

function removeNewCheckpoint(btn) {
    btn.closest('.checkpoint-item').remove();
    renumberCheckpoints();
    updateCheckpointCount();
}

async function saveCheckpoint(btn) {
    const item = btn.closest('.checkpoint-item');
    const id = item.dataset.id;
    const name = item.querySelector('.checkpoint-name').value;
    const lat = parseFloat(item.querySelector('.checkpoint-lat').value);
    const lon = parseFloat(item.querySelector('.checkpoint-lon').value);
    const sequence = parseInt(item.dataset.sequence);
    
    if (!name || isNaN(lat) || isNaN(lon)) {
        alert('Please fill in all fields');
        return;
    }
    
    try {
        let response;
        if (id === 'new') {
            // Create new checkpoint
            const formData = new FormData();
            formData.append('nav_id', {{ nav.id }});
            formData.append('name', name);
            formData.append('lat', lat);
            formData.append('lon', lon);
            formData.append('sequence', sequence);
            
            response = await fetch('/coach/navs/checkpoints/create', {
                method: 'POST',
                body: formData
            });
        } else {
            // Update existing checkpoint
            const formData = new FormData();
            formData.append('name', name);
            formData.append('lat', lat);
            formData.append('lon', lon);
            formData.append('sequence', sequence);
            
            response = await fetch('/coach/navs/checkpoints/' + id + '/update', {
                method: 'POST',
                body: formData
            });
        }
        
        if (response.ok) {
            location.reload();
        } else {
            alert('Error saving checkpoint');
        }
    } catch (error) {
        console.error('Error:', error);
        alert('Error saving checkpoint');
    }
}

async function deleteCheckpoint(id) {
    if (!confirm('Delete this checkpoint?')) return;
    
    try {
        const response = await fetch('/coach/navs/checkpoints/' + id + '/delete', {
            method: 'POST'
        });
        
        if (response.ok) {
            location.reload();
        } else {
            alert('Error deleting checkpoint');
        }
    } catch (error) {
        console.error('Error:', error);
        alert('Error deleting checkpoint');
    }
}

function renumberCheckpoints() {
    const items = document.querySelectorAll('.checkpoint-item');
    items.forEach((item, index) => {
        const sequence = index + 1;
        item.dataset.sequence = sequence;
        item.querySelector('.sequence-num').textContent = sequence;
    });
}

function updateCheckpointCount() {
    const count = document.querySelectorAll('.checkpoint-item').length;
    document.getElementById('checkpointCount').textContent = count;
    updateMoveButtons();
}

function updateMoveButtons() {
    const items = document.querySelectorAll('.checkpoint-item');
    items.forEach((item, index) => {
        const id = item.dataset.id;
        const moveUpBtn = document.getElementById(`moveup-${id}`);
        const moveDownBtn = document.getElementById(`movedown-${id}`);
        
        if (moveUpBtn) {
            moveUpBtn.disabled = index === 0;
        }
        if (moveDownBtn) {
            moveDownBtn.disabled = index === items.length - 1;
        }
    });
}

function moveCheckpointUp(btn) {
    const item = btn.closest('.checkpoint-item');
    const prevItem = item.previousElementSibling;
    if (prevItem) {
        item.parentElement.insertBefore(item, prevItem);
        renumberCheckpoints();
        saveCheckpointOrder();
    }
}

function moveCheckpointDown(btn) {
    const item = btn.closest('.checkpoint-item');
    const nextItem = item.nextElementSibling;
    if (nextItem && nextItem.nextElementSibling) {
        item.parentElement.insertBefore(nextItem, item);
    } else if (nextItem) {
        item.parentElement.appendChild(nextItem);
    }
    renumberCheckpoints();
    saveCheckpointOrder();
}

async function saveCheckpointOrder() {
    const items = document.querySelectorAll('.checkpoint-item');
    const updates = [];
    items.forEach(item => {
        if (item.dataset.id !== 'new') {
            updates.push({
                id: parseInt(item.dataset.id),
                sequence: parseInt(item.dataset.sequence)
            });
        }
    });
    
    try {
        await fetch('/coach/navs/checkpoints/reorder', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ nav_id: {{ nav.id }}, checkpoints: updates })
        });
    } catch (error) {
        console.error('Error saving sequence:', error);
    }
}

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    updateMoveButtons();
});

// PDF Upload functions
async function uploadPdf(event, navId) {
    event.preventDefault();
    const fileInput = document.getElementById('pdf-file');
    const file = fileInput.files[0];
    
    if (!file) {
        alert('Please select a file');
        return;
    }
    
    if (!file.name.toLowerCase().endsWith('.pdf')) {
        alert('Only PDF files are allowed');
        return;
    }
    
    const formData = new FormData();
    formData.append('pdf_file', file);
    
    try {
        const response = await fetch(`/coach/navs/${navId}/upload-pdf`, {
            method: 'POST',
            body: formData
        });
        
        const data = await response.json();
        if (data.success) {
            alert('PDF uploaded successfully!');
            location.reload();
        } else {
            alert('Error uploading PDF: ' + data.message);
        }
    } catch (error) {
        console.error('Error:', error);
        alert('Error uploading PDF');
    }
}

function cancelPdfUpload() {
    document.getElementById('pdf-upload-form').style.display = 'none';
    document.getElementById('pdf-file').value = '';
}

async function deletePdf(navId) {
    if (!confirm('Delete the NAV packet PDF? Members will no longer be able to download it.')) {
        return;
    }
    
    try {
        const response = await fetch(`/coach/navs/${navId}/delete-pdf`, {
            method: 'POST'
        });
        
        const data = await response.json();
        if (data.success) {
            alert('PDF deleted successfully!');
            location.reload();
        } else {
            alert('Error deleting PDF: ' + data.message);
        }
    } catch (error) {
        console.error('Error:', error);
        alert('Error deleting PDF');
    }
}
</script>

{% endblock %}
