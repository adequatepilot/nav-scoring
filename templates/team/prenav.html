{% extends "base.html" %}

{% block title %}Pre-Flight Plan - NAV Scoring{% endblock %}

{% block navbar %}
<div class="navbar">
    <div class="navbar-brand">
        <button class="hamburger" id="hamburgerBtn">☰</button>
        <h1>NAV Scoring - Pre-Flight Plan</h1>
    </div>
    <div class="navbar-links" id="navbarLinks">
        <a href="/dashboard">Dashboard</a>
        <a href="/profile">Profile</a>
        <a href="/logout">Logout</a>
    </div>
</div>
{% endblock %}

{% block content %}
<h2>Submit Pre-Flight Plan</h2>
<div style="margin-bottom: 1.5rem;">
    <a href="/dashboard" style="display: inline-block; background: #8B0015; color: white; padding: 0.75rem 1.5rem; border-radius: 5px; text-decoration: none; transition: transform 0.2s;">← Return to Dashboard</a>
</div>

<!-- Pass nav data to JavaScript for lookup -->
<script>
const NAV_DATA = {
    {% for nav in navs %}
    '{{ nav.id }}': {
        'id': '{{ nav.id }}',
        'name': '{{ nav.name }}',
        'checkpoints': {{ nav.checkpoints|length }}
    }{{ "," if not loop.last else "" }}
    {% endfor %}
};
</script>

{% if error %}
<div class="error">{{ error }}</div>
{% endif %}

{% if is_coach or is_admin %}
<!-- Coach: Show pairing selector and full form -->
<form method="POST" action="/prenav" id="prenavForm">
    <div class="form-group">
        <label for="pairing_id">Select Pairing:</label>
        <select id="pairing_id" name="pairing_id" required>
            <option value="">-- Select Team --</option>
            {% for pairing in pairings_for_dropdown %}
            <option value="{{ pairing.id }}">{{ pairing.display_name }}</option>
            {% endfor %}
        </select>
    </div>
    
    <div class="form-group">
        <label for="nav_id">Select NAV Route:</label>
        <select id="nav_id" name="nav_id" required onchange="updateCheckpointFields()">
            <option value="">-- Select NAV --</option>
            {% for nav in navs %}
            <option value="{{ nav.id }}" data-checkpoints="{{ nav.checkpoints|length }}" {% if nav_id and nav.id|string == nav_id|string %}selected{% endif %}>{{ nav.name }}</option>
            {% endfor %}
        </select>
    </div>
    
    <!-- Route Confirmation Message -->
    <div id="route_confirmation" style="display: none; background: #e3f2fd; padding: 1rem; margin: 1rem 0; border-left: 4px solid #2196F3; border-radius: 4px;">
        <strong style="font-size: 1.1em;">✓ Route Selected:</strong> <span id="selected_route_name" style="font-weight: bold; color: #1976D2;"></span><br>
        <small style="color: #666;">Complete the flight plan below and submit when ready.</small>
    </div>
    
    <div id="leg_times_container" style="display: none;">
        <h3>Leg Times (HH:MM:SS format)</h3>
        <div id="leg_times_fields"></div>
    </div>
    
    <div class="form-group" style="display: none;" id="total_time_group">
        <label>Total Flight Time (HH:MM:SS):</label>
        <div style="display: flex; gap: 10px; align-items: center;">
            <div>
                <label for="total_hh" style="font-size: 0.85em;">Hours</label>
                <input type="number" id="total_hh" name="total_hh" 
                       min="0" value="0" class="time-input" required style="width: 60px;">
            </div>
            <div>
                <label for="total_mm" style="font-size: 0.85em;">Minutes</label>
                <input type="number" id="total_mm" name="total_mm" 
                       min="0" max="59" value="0" class="time-input" required style="width: 60px;">
            </div>
            <div>
                <label for="total_ss" style="font-size: 0.85em;">Seconds</label>
                <input type="number" id="total_ss" name="total_ss" 
                       min="0" max="59" value="0" class="time-input" required style="width: 60px;">
            </div>
        </div>
    </div>
    
    <div class="form-group" style="display: none;" id="fuel_group">
        <label style="display: block; margin-bottom: 0.5rem;">Estimated Fuel Burn (gallons):</label>
        <div style="display: flex; align-items: flex-end; gap: 0.5rem;">
            <div style="display: flex; flex-direction: column; align-items: center;">
                <label for="fuel_gallons" style="font-size: 0.85em; margin-bottom: 0.25rem; color: #333;">Gallons</label>
                <input type="number" id="fuel_gallons" name="fuel_gallons" 
                       min="0" max="99" value="0" placeholder="0" required 
                       style="width: 60px; padding: 0.5rem; font-size: 1rem; text-align: center;">
            </div>
            <div style="font-size: 1.8em; font-weight: bold; color: #8B0015; display: flex; align-items: center; line-height: 1; padding-bottom: 0.5rem;">.</div>
            <div style="display: flex; flex-direction: column; align-items: center;">
                <label for="fuel_tenths" style="font-size: 0.85em; margin-bottom: 0.25rem; color: #333;">Tenths</label>
                <input type="number" id="fuel_tenths" name="fuel_tenths" 
                       min="0" max="9" value="0" placeholder="0" required 
                       style="width: 60px; padding: 0.5rem; font-size: 1rem; text-align: center;">
            </div>
        </div>
        <small style="color: #666; display: block; margin-top: 0.5rem;">Enter gallons (0-99) and tenths (0-9). Example: 10 gallons + 5 tenths = 10.5 gallons</small>
    </div>
    
    <input type="hidden" id="leg_times_str" name="leg_times_str">
    <input type="hidden" id="total_time_str" name="total_time_str">
    <input type="hidden" id="fuel_estimate" name="fuel_estimate">
    
    <button type="submit">Submit Pre-Flight Plan</button>
</form>

{% else %}
<!-- Competitor: Show their pairing or error -->
{% if not pairing %}
<div class="error">
    <strong>No Active Pairing!</strong><br>
    You are not currently paired with another team member. Contact your coach to set up a pairing.
</div>
{% else %}

<div class="info">
    <strong>Your Pairing:</strong><br>
    Pilot: {{ pairing.pilot_name }}<br>
    Observer: {{ pairing.observer_name }}
</div>

<form method="POST" action="/prenav" id="prenavForm">
    <input type="hidden" name="pairing_id" value="{{ pairing.id }}">
    
    {% if nav_id %}
    <!-- NAV is pre-selected from assignment workflow -->
    <div class="info" style="background: #e3f2fd; padding: 1rem; margin: 1rem 0; border-left: 4px solid #2196F3; border-radius: 4px; margin-bottom: 1.5rem;">
        <strong style="font-size: 1.1em;">✓ NAV Selected from Assignment</strong>
        <input type="hidden" id="nav_id" name="nav_id" value="{{ nav_id }}">
    </div>
    {% else %}
    <div class="form-group">
        <label for="nav_id">Select NAV Route:</label>
        <select id="nav_id" name="nav_id" required onchange="updateCheckpointFields()">
            <option value="">-- Select NAV --</option>
            {% for nav in navs %}
            <option value="{{ nav.id }}" data-checkpoints="{{ nav.checkpoints|length }}">{{ nav.name }}</option>
            {% endfor %}
        </select>
    </div>
    {% endif %}
    
    <!-- Route Confirmation Message -->
    <div id="route_confirmation" style="display: none; background: #e3f2fd; padding: 1rem; margin: 1rem 0; border-left: 4px solid #2196F3; border-radius: 4px;">
        <strong style="font-size: 1.1em;">✓ Route Selected:</strong> <span id="selected_route_name" style="font-weight: bold; color: #1976D2;"></span><br>
        <small style="color: #666;">Complete the flight plan below and submit when ready.</small>
    </div>
    
    <div id="leg_times_container" style="display: none;">
        <h3>Leg Times (HH:MM:SS format)</h3>
        <div id="leg_times_fields"></div>
    </div>
    
    <div class="form-group" style="display: none;" id="total_time_group">
        <label>Total Flight Time (HH:MM:SS):</label>
        <div style="display: flex; gap: 10px; align-items: center;">
            <div>
                <label for="total_hh" style="font-size: 0.85em;">Hours</label>
                <input type="number" id="total_hh" name="total_hh" 
                       min="0" value="0" class="time-input" required style="width: 60px;">
            </div>
            <div>
                <label for="total_mm" style="font-size: 0.85em;">Minutes</label>
                <input type="number" id="total_mm" name="total_mm" 
                       min="0" max="59" value="0" class="time-input" required style="width: 60px;">
            </div>
            <div>
                <label for="total_ss" style="font-size: 0.85em;">Seconds</label>
                <input type="number" id="total_ss" name="total_ss" 
                       min="0" max="59" value="0" class="time-input" required style="width: 60px;">
            </div>
        </div>
    </div>
    
    <div class="form-group" style="display: none;" id="fuel_group">
        <label style="display: block; margin-bottom: 0.5rem;">Estimated Fuel Burn (gallons):</label>
        <div style="display: flex; align-items: flex-end; gap: 0.5rem;">
            <div style="display: flex; flex-direction: column; align-items: center;">
                <label for="fuel_gallons" style="font-size: 0.85em; margin-bottom: 0.25rem; color: #333;">Gallons</label>
                <input type="number" id="fuel_gallons" name="fuel_gallons" 
                       min="0" max="99" value="0" placeholder="0" required 
                       style="width: 60px; padding: 0.5rem; font-size: 1rem; text-align: center;">
            </div>
            <div style="font-size: 1.8em; font-weight: bold; color: #8B0015; display: flex; align-items: center; line-height: 1; padding-bottom: 0.5rem;">.</div>
            <div style="display: flex; flex-direction: column; align-items: center;">
                <label for="fuel_tenths" style="font-size: 0.85em; margin-bottom: 0.25rem; color: #333;">Tenths</label>
                <input type="number" id="fuel_tenths" name="fuel_tenths" 
                       min="0" max="9" value="0" placeholder="0" required 
                       style="width: 60px; padding: 0.5rem; font-size: 1rem; text-align: center;">
            </div>
        </div>
        <small style="color: #666; display: block; margin-top: 0.5rem;">Enter gallons (0-99) and tenths (0-9). Example: 10 gallons + 5 tenths = 10.5 gallons</small>
    </div>
    
    <input type="hidden" id="leg_times_str" name="leg_times_str">
    <input type="hidden" id="total_time_str" name="total_time_str">
    <input type="hidden" id="fuel_estimate" name="fuel_estimate">
    
    <button type="submit">Submit Pre-Flight Plan</button>
</form>

{% endif %}
{% endif %}

<script>
function updateCheckpointFields() {
    const navSelect = document.getElementById('nav_id');
    const navId = navSelect.value;
    
    if (!navId) {
        document.getElementById('leg_times_container').style.display = 'none';
        document.getElementById('total_time_group').style.display = 'none';
        document.getElementById('fuel_group').style.display = 'none';
        document.getElementById('route_confirmation').style.display = 'none';
        return;
    }
    
    // Look up nav data from the global NAV_DATA object
    const navInfo = NAV_DATA[navId];
    if (!navInfo) {
        console.error('NAV data not found for ID:', navId);
        return;
    }
    
    const numCheckpoints = navInfo.checkpoints;
    const routeName = navInfo.name;
    
    if (numCheckpoints === 0) {
        document.getElementById('leg_times_container').style.display = 'none';
        document.getElementById('total_time_group').style.display = 'none';
        document.getElementById('fuel_group').style.display = 'none';
        document.getElementById('route_confirmation').style.display = 'none';
        return;
    }
    
    // Show containers and confirmation
    document.getElementById('leg_times_container').style.display = 'block';
    document.getElementById('total_time_group').style.display = 'block';
    document.getElementById('fuel_group').style.display = 'block';
    document.getElementById('route_confirmation').style.display = 'block';
    document.getElementById('selected_route_name').innerText = routeName;
    
    // Generate leg time input fields with HH:MM:SS format
    const container = document.getElementById('leg_times_fields');
    container.innerHTML = '';
    
    for (let i = 0; i < numCheckpoints; i++) {
        const div = document.createElement('div');
        div.className = 'form-group';
        div.innerHTML = `
            <label>Leg ${i + 1} Time (HH:MM:SS):</label>
            <div style="display: flex; gap: 10px; align-items: center;">
                <div>
                    <label for="leg_${i}_hh" style="font-size: 0.85em;">Hours</label>
                    <input type="number" id="leg_${i}_hh" name="leg_${i}_hh" 
                           min="0" value="0" class="time-input" required style="width: 60px;">
                </div>
                <div>
                    <label for="leg_${i}_mm" style="font-size: 0.85em;">Minutes</label>
                    <input type="number" id="leg_${i}_mm" name="leg_${i}_mm" 
                           min="0" max="59" value="0" class="time-input" required style="width: 60px;">
                </div>
                <div>
                    <label for="leg_${i}_ss" style="font-size: 0.85em;">Seconds</label>
                    <input type="number" id="leg_${i}_ss" name="leg_${i}_ss" 
                           min="0" max="59" value="0" class="time-input" required style="width: 60px;">
                </div>
            </div>
        `;
        container.appendChild(div);
    }
}

// Helper function to convert HH:MM:SS to seconds
function timeToSeconds(hours, minutes, seconds) {
    hours = parseInt(hours || 0);
    minutes = parseInt(minutes || 0);
    seconds = parseInt(seconds || 0);
    return hours * 3600 + minutes * 60 + seconds;
}

document.getElementById('prenavForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    // Validate nav selection
    const navSelect = document.getElementById('nav_id');
    const navId = navSelect.value;
    if (!navId) {
        alert('Please select a NAV route');
        return;
    }
    
    // Get checkpoint count from NAV_DATA object (works for both select and hidden input)
    const navInfo = NAV_DATA[navId];
    if (!navInfo) {
        alert('NAV route not found');
        return;
    }
    
    const numCheckpoints = navInfo.checkpoints;
    
    if (numCheckpoints === 0) {
        alert('Selected NAV has no checkpoints');
        return;
    }
    
    // Validate and convert leg times to seconds
    const legTimes = [];
    for (let i = 0; i < numCheckpoints; i++) {
        const hh = document.getElementById(`leg_${i}_hh`).value || '0';
        const mm = document.getElementById(`leg_${i}_mm`).value || '0';
        const ss = document.getElementById(`leg_${i}_ss`).value || '0';
        
        if (!hh && !mm && !ss) {
            alert(`Please enter time for Leg ${i + 1}`);
            return;
        }
        
        // Validate that all values are numbers
        if (isNaN(hh) || isNaN(mm) || isNaN(ss)) {
            alert(`Leg ${i + 1} time must contain only numbers`);
            return;
        }
        
        const totalSeconds = timeToSeconds(hh, mm, ss);
        legTimes.push(totalSeconds);
    }
    
    // Validate total time (HH:MM:SS)
    const totalHh = document.getElementById('total_hh').value || '0';
    const totalMm = document.getElementById('total_mm').value || '0';
    const totalSs = document.getElementById('total_ss').value || '0';
    
    if (!totalHh && !totalMm && !totalSs) {
        alert('Please enter total flight time');
        return;
    }
    
    // Validate that all values are numbers
    if (isNaN(totalHh) || isNaN(totalMm) || isNaN(totalSs)) {
        alert('Total time must contain only numbers');
        return;
    }
    
    const totalTimeSeconds = timeToSeconds(totalHh, totalMm, totalSs);
    
    // Validate and combine fuel gallons and tenths
    const fuelGallons = document.getElementById('fuel_gallons').value;
    const fuelTenths = document.getElementById('fuel_tenths').value;
    
    if (!fuelGallons || !fuelTenths) {
        alert('Please enter fuel estimate (both gallons and tenths)');
        return;
    }
    
    // Validate that values are numbers
    if (isNaN(fuelGallons) || isNaN(fuelTenths)) {
        alert('Fuel values must contain only numbers');
        return;
    }
    
    // Validate ranges
    const gallonsNum = parseInt(fuelGallons);
    const tenthsNum = parseInt(fuelTenths);
    
    if (gallonsNum < 0 || gallonsNum > 99) {
        alert('Gallons must be between 0 and 99');
        return;
    }
    
    if (tenthsNum < 0 || tenthsNum > 9) {
        alert('Tenths must be between 0 and 9');
        return;
    }
    
    // Combine gallons and tenths into fuel_estimate (e.g., "10.5")
    const combinedFuel = gallonsNum + '.' + tenthsNum;
    document.getElementById('fuel_estimate').value = combinedFuel;
    
    // Store leg times and total time as JSON arrays of seconds
    document.getElementById('leg_times_str').value = JSON.stringify(legTimes);
    document.getElementById('total_time_str').value = totalTimeSeconds.toString();
    
    // Submit form
    this.submit();
});

// Initialize form if nav_id is pre-selected (from assignment workflow)
document.addEventListener('DOMContentLoaded', function() {
    const navSelect = document.getElementById('nav_id');
    if (navSelect && navSelect.value) {
        // NAV is already selected, trigger the form setup
        updateCheckpointFields();
    }
});
</script>
{% endblock %}
