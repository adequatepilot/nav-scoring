{% extends "base.html" %}

{% block title %}Pre-Flight Plan - NAV Scoring{% endblock %}

{% block navbar %}
<div class="navbar">
    <div class="navbar-brand">
        <button class="hamburger" id="hamburgerBtn">☰</button>
        <h1>NAV Scoring - Pre-Flight Plan</h1>
    </div>
    <div class="navbar-links" id="navbarLinks">
        <span>{{ member_name }}</span>
        <a href="/team">Dashboard</a>
        <a href="/flight">Post-Flight</a>
        <a href="/results">Results</a>
        <a href="/logout">Logout</a>
    </div>
</div>
{% endblock %}

{% block content %}
<h2>Submit Pre-Flight Plan</h2>

{% if error %}
<div class="error">{{ error }}</div>
{% endif %}

{% if not pairing %}
<div class="error">
    <strong>No Active Pairing!</strong><br>
    You are not currently paired with another team member. Contact your coach to set up a pairing.
</div>
{% else %}

<div class="info">
    <strong>Your Pairing:</strong><br>
    Pilot: {{ pairing.pilot_name }}<br>
    Observer: {{ pairing.observer_name }}
</div>

<div id="submissionError" style="display: none; color: #d32f2f; background: #ffebee; padding: 15px; border-radius: 4px; margin-bottom: 20px;"></div>

<form method="POST" id="prenavForm">
    <div class="form-group">
        <label for="nav_id">Select NAV Route:</label>
        <select id="nav_id" name="nav_id" required onchange="updateCheckpointFields()">
            <option value="">-- Select NAV --</option>
            {% for nav in navs %}
            <option value="{{ nav.id }}" data-checkpoints="{{ nav.checkpoints|length }}">{{ nav.name }}</option>
            {% endfor %}
        </select>
    </div>
    
    <div id="leg_times_container" style="display: none;">
        <h3>Leg Times</h3>
        <p style="color: #666; font-size: 0.9rem;">Enter hours, minutes, and seconds separately for each leg.</p>
        <div id="leg_times_fields"></div>
    </div>
    
    <div class="form-group" style="display: none;" id="total_time_group">
        <label for="total_time_str">Total Flight Time (MM:SS):</label>
        <input type="text" id="total_time_str" name="total_time_str" 
               placeholder="48:30" pattern="\d+:\d{2}" class="time-input" required>
        <small style="color: #666;">Example: 48:30 (48 minutes, 30 seconds)</small>
    </div>
    
    <div class="form-group" style="display: none;" id="fuel_group">
        <label for="fuel_estimate">Estimated Fuel Burn (gallons):</label>
        <input type="number" id="fuel_estimate" name="fuel_estimate" 
               step="0.1" min="0" max="9999.9" placeholder="8.5" required>
        <small style="color: #666;">Enter to nearest 0.1 gallon (e.g., 8.5)</small>
    </div>
    
    <input type="hidden" id="leg_times_str" name="leg_times_str">
    <input type="hidden" id="nav_id_hidden" name="nav_id">
    
    <button type="submit" id="submitBtn">Submit Pre-Flight Plan</button>
</form>

<script>
function updateCheckpointFields() {
    const navSelect = document.getElementById('nav_id');
    const selectedOption = navSelect.options[navSelect.selectedIndex];
    const numCheckpoints = parseInt(selectedOption.dataset.checkpoints || 0);
    
    if (numCheckpoints === 0) {
        document.getElementById('leg_times_container').style.display = 'none';
        document.getElementById('total_time_group').style.display = 'none';
        document.getElementById('fuel_group').style.display = 'none';
        return;
    }
    
    // Show containers
    document.getElementById('leg_times_container').style.display = 'block';
    document.getElementById('total_time_group').style.display = 'block';
    document.getElementById('fuel_group').style.display = 'block';
    
    // Generate leg time input fields with separate HH/MM/SS
    const container = document.getElementById('leg_times_fields');
    container.innerHTML = '';
    
    for (let i = 0; i < numCheckpoints; i++) {
        const div = document.createElement('div');
        div.className = 'form-group';
        div.style.display = 'flex';
        div.style.gap = '1rem';
        div.style.alignItems = 'center';
        div.innerHTML = `
            <label for="leg_${i}_hh" style="min-width: 80px;">Leg ${i + 1}:</label>
            <div style="display: flex; gap: 0.5rem; align-items: center;">
                <input type="number" id="leg_${i}_hh" name="leg_${i}_hh" 
                       min="0" max="23" placeholder="HH" style="width: 60px;" required>
                <span>:</span>
                <input type="number" id="leg_${i}_mm" name="leg_${i}_mm" 
                       min="0" max="59" placeholder="MM" style="width: 60px;" required>
                <span>:</span>
                <input type="number" id="leg_${i}_ss" name="leg_${i}_ss" 
                       min="0" max="59" placeholder="SS" style="width: 60px;" required>
            </div>
        `;
        container.appendChild(div);
    }
}

document.getElementById('prenavForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const submitBtn = document.getElementById('submitBtn');
    const errorDiv = document.getElementById('submissionError');
    
    try {
        // Clear previous errors
        errorDiv.style.display = 'none';
        errorDiv.textContent = '';
        submitBtn.disabled = true;
        submitBtn.textContent = 'Submitting...';
        
        // Validate nav selection
        const navSelect = document.getElementById('nav_id');
        const navId = navSelect.value;
        if (!navId) {
            throw new Error('Please select a NAV route');
        }
        
        const selectedOption = navSelect.options[navSelect.selectedIndex];
        const numCheckpoints = parseInt(selectedOption.dataset.checkpoints || 0);
        
        if (numCheckpoints === 0) {
            throw new Error('Selected NAV has no checkpoints');
        }
        
        // Validate leg times and convert HH:MM:SS to seconds
        const legTimes = [];
        for (let i = 0; i < numCheckpoints; i++) {
            const hh = parseInt(document.getElementById(`leg_${i}_hh`).value || 0);
            const mm = parseInt(document.getElementById(`leg_${i}_mm`).value || 0);
            const ss = parseInt(document.getElementById(`leg_${i}_ss`).value || 0);
            
            if (isNaN(hh) || isNaN(mm) || isNaN(ss)) {
                throw new Error(`Please enter valid time for Leg ${i + 1}`);
            }
            
            if (mm < 0 || mm > 59 || ss < 0 || ss > 59) {
                throw new Error(`Invalid minutes or seconds for Leg ${i + 1}`);
            }
            
            // Convert to total seconds
            const totalSeconds = hh * 3600 + mm * 60 + ss;
            legTimes.push(totalSeconds);
        }
        
        // Validate and parse total time (MM:SS format)
        const totalTimeStr = document.getElementById('total_time_str').value;
        if (!totalTimeStr) {
            throw new Error('Please enter total flight time');
        }
        
        // Parse MM:SS to seconds
        const timeParts = totalTimeStr.split(':');
        if (timeParts.length !== 2) {
            throw new Error('Total flight time must be in MM:SS format (e.g., 48:30)');
        }
        
        const totalMinutes = parseInt(timeParts[0]);
        const totalSeconds = parseInt(timeParts[1]);
        if (isNaN(totalMinutes) || isNaN(totalSeconds) || totalSeconds < 0 || totalSeconds > 59) {
            throw new Error('Invalid total flight time format');
        }
        
        const totalTimeInSeconds = totalMinutes * 60 + totalSeconds;
        
        // Validate fuel estimate
        const fuelEstimate = document.getElementById('fuel_estimate').value;
        if (!fuelEstimate || parseFloat(fuelEstimate) < 0) {
            throw new Error('Please enter valid fuel estimate');
        }
        
        // Prepare form data
        const formData = new FormData();
        formData.append('nav_id', navId);
        formData.append('leg_times_str', JSON.stringify(legTimes));
        formData.append('total_time_str', totalTimeInSeconds.toString());
        formData.append('fuel_estimate', fuelEstimate);
        
        // Submit via AJAX
        const response = await fetch('/prenav', {
            method: 'POST',
            body: formData
        });
        
        if (!response.ok) {
            const contentType = response.headers.get('content-type');
            let errorMessage = `Submission failed: ${response.statusText}`;
            
            if (contentType && contentType.includes('application/json')) {
                const errorData = await response.json();
                errorMessage = errorData.detail || errorMessage;
            }
            
            throw new Error(errorMessage);
        }
        
        // Redirect to confirmation page
        const redirectUrl = response.url || '/prenav_confirmation?token=' + new URLSearchParams(response.headers.get('Location')).get('token');
        if (response.redirected) {
            window.location.href = response.url;
        } else {
            // Fallback - check if response has Location header
            const location = response.headers.get('Location');
            if (location) {
                window.location.href = location;
            } else {
                // If response is successful but no redirect, assume success and show message
                errorDiv.style.backgroundColor = '#e8f5e9';
                errorDiv.style.color = '#2e7d32';
                errorDiv.textContent = 'Pre-flight plan submitted successfully! Redirecting...';
                errorDiv.style.display = 'block';
                setTimeout(() => {
                    window.location.href = '/team';
                }, 2000);
            }
        }
    } catch (error) {
        // Show error message to user
        errorDiv.textContent = '❌ ' + error.message;
        errorDiv.style.display = 'block';
        submitBtn.disabled = false;
        submitBtn.textContent = 'Submit Pre-Flight Plan';
    }
});
</script>

{% endif %}
{% endblock %}
