{% extends "base.html" %}

{% block title %}Pre-Flight Plan - NAV Scoring{% endblock %}

{% block content %}
<h2>Submit Pre-Flight Plan</h2>

{% if error %}
<div class="error">{{ error }}</div>
{% endif %}

{% if not pairing %}
<div class="error">
    <strong>No Active Pairing!</strong><br>
    You are not currently paired with another team member. Contact your coach to set up a pairing.
</div>
{% else %}

<div class="info">
    <strong>Your Pairing:</strong><br>
    Pilot: {{ pairing.pilot_name }}<br>
    Observer: {{ pairing.observer_name }}
</div>

<form method="POST" action="/prenav" id="prenavForm">
    <div class="form-group">
        <label for="nav_id">Select NAV Route:</label>
        <select id="nav_id" name="nav_id" required onchange="updateCheckpointFields()">
            <option value="">-- Select NAV --</option>
            {% for nav in navs %}
            <option value="{{ nav.id }}" data-checkpoints="{{ nav.checkpoints|length }}">{{ nav.name }}</option>
            {% endfor %}
        </select>
    </div>
    
    <div id="leg_times_container" style="display: none;">
        <h3>Leg Times (HH:MM:SS format) - Issue 16</h3>
        <div id="leg_times_fields"></div>
    </div>
    
    <div class="form-group" style="display: none;" id="total_time_group">
        <label for="total_time_hours">Total Flight Time:</label>
        <div style="display: flex; gap: 0.5rem; align-items: center;">
            <div style="flex: 1;">
                <input type="number" id="total_time_hours" name="total_time_hours" 
                       min="0" max="23" placeholder="HH" class="time-input" required>
                <small style="color: #666;">Hours</small>
            </div>
            <div style="flex: 1;">
                <input type="number" id="total_time_minutes" name="total_time_minutes" 
                       min="0" max="59" placeholder="MM" class="time-input" required>
                <small style="color: #666;">Minutes</small>
            </div>
            <div style="flex: 1;">
                <input type="number" id="total_time_seconds" name="total_time_seconds" 
                       min="0" max="59" placeholder="SS" class="time-input" required>
                <small style="color: #666;">Seconds</small>
            </div>
        </div>
    </div>
    
    <div class="form-group" style="display: none;" id="fuel_group">
        <label for="fuel_estimate">Estimated Fuel Burn (gallons) - Issue 17:</label>
        <input type="number" id="fuel_estimate" name="fuel_estimate" 
               step="0.1" min="0" placeholder="8.5" required>
        <small style="color: #666;">Precision to 0.1 gallon</small>
    </div>
    
    <input type="hidden" id="leg_times_str" name="leg_times_str">
    <input type="hidden" id="total_time_str" name="total_time_str">
    
    <button type="submit">Submit Pre-Flight Plan</button>
</form>

<script>
function updateCheckpointFields() {
    const navSelect = document.getElementById('nav_id');
    const selectedOption = navSelect.options[navSelect.selectedIndex];
    const numCheckpoints = parseInt(selectedOption.dataset.checkpoints || 0);
    
    if (numCheckpoints === 0) {
        document.getElementById('leg_times_container').style.display = 'none';
        document.getElementById('total_time_group').style.display = 'none';
        document.getElementById('fuel_group').style.display = 'none';
        return;
    }
    
    // Show containers
    document.getElementById('leg_times_container').style.display = 'block';
    document.getElementById('total_time_group').style.display = 'block';
    document.getElementById('fuel_group').style.display = 'block';
    
    // Generate leg time input fields - Issue 16: HH:MM:SS individual boxes
    const container = document.getElementById('leg_times_fields');
    container.innerHTML = '';
    
    for (let i = 0; i < numCheckpoints; i++) {
        const div = document.createElement('div');
        div.className = 'form-group';
        div.innerHTML = `
            <label>Leg ${i + 1} Time (HH:MM:SS):</label>
            <div style="display: flex; gap: 0.5rem; align-items: center;">
                <div style="flex: 1;">
                    <input type="number" id="leg_${i}_hours" name="leg_${i}_hours" 
                           min="0" max="23" placeholder="HH" class="time-input" required>
                    <small style="color: #666;">Hours</small>
                </div>
                <div style="flex: 1;">
                    <input type="number" id="leg_${i}_minutes" name="leg_${i}_minutes" 
                           min="0" max="59" placeholder="MM" class="time-input" required>
                    <small style="color: #666;">Minutes</small>
                </div>
                <div style="flex: 1;">
                    <input type="number" id="leg_${i}_seconds" name="leg_${i}_seconds" 
                           min="0" max="59" placeholder="SS" class="time-input" required>
                    <small style="color: #666;">Seconds</small>
                </div>
            </div>
        `;
        container.appendChild(div);
    }
}

document.getElementById('prenavForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    // Validate nav selection
    const navSelect = document.getElementById('nav_id');
    const navId = navSelect.value;
    if (!navId) {
        alert('Please select a NAV route');
        return;
    }
    
    const selectedOption = navSelect.options[navSelect.selectedIndex];
    const numCheckpoints = parseInt(selectedOption.dataset.checkpoints || 0);
    
    if (numCheckpoints === 0) {
        alert('Selected NAV has no checkpoints');
        return;
    }
    
    // Validate and convert leg times to seconds - Issue 16: HH:MM:SS
    const legTimes = [];
    for (let i = 0; i < numCheckpoints; i++) {
        const hours = parseInt(document.getElementById(`leg_${i}_hours`).value || 0);
        const minutes = parseInt(document.getElementById(`leg_${i}_minutes`).value || 0);
        const seconds = parseInt(document.getElementById(`leg_${i}_seconds`).value || 0);
        
        if (hours < 0 || hours > 23 || minutes < 0 || minutes > 59 || seconds < 0 || seconds > 59) {
            alert(`Please enter valid time for Leg ${i + 1} (HH:MM:SS)`);
            return;
        }
        
        const totalSeconds = (hours * 3600) + (minutes * 60) + seconds;
        if (totalSeconds === 0) {
            alert(`Please enter non-zero time for Leg ${i + 1}`);
            return;
        }
        legTimes.push(totalSeconds);
    }
    
    // Validate total time - convert HH:MM:SS to seconds
    const totalHours = parseInt(document.getElementById('total_time_hours').value || 0);
    const totalMinutes = parseInt(document.getElementById('total_time_minutes').value || 0);
    const totalSeconds = parseInt(document.getElementById('total_time_seconds').value || 0);
    
    if (totalHours < 0 || totalMinutes < 0 || totalSeconds < 0) {
        alert('Please enter valid total flight time');
        return;
    }
    
    const totalTimeSeconds = (totalHours * 3600) + (totalMinutes * 60) + totalSeconds;
    if (totalTimeSeconds === 0) {
        alert('Please enter non-zero total flight time');
        return;
    }
    
    // Validate fuel estimate
    const fuelEstimate = document.getElementById('fuel_estimate').value;
    if (!fuelEstimate || parseFloat(fuelEstimate) < 0) {
        alert('Please enter valid fuel estimate');
        return;
    }
    
    // Store leg times as JSON (converted to seconds)
    document.getElementById('leg_times_str').value = JSON.stringify(legTimes);
    
    // Store total time as seconds in a simple format
    document.getElementById('total_time_str').value = totalTimeSeconds.toString();
    
    // Submit form
    this.submit();
});
</script>

{% endif %}
{% endblock %}
