{% extends "base.html" %}

{% block title %}Flight Results - NAV Scoring{% endblock %}

{% block navbar %}
<div class="navbar">
    <div class="navbar-brand">
        <button class="hamburger" id="hamburgerBtn">☰</button>
        <h1>NAV Scoring - Results</h1>
    </div>
    <div class="navbar-links" id="navbarLinks">
        <a href="/dashboard">Dashboard</a>
        <a href="/profile">Profile</a>
        <a href="/logout">Logout</a>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
.card {
    max-width: 1000px;
}
.score-header {
    background: linear-gradient(135deg, #B0B0B0 0%, #4A4A4A 100%);
    color: white;
    padding: 2rem;
    border-radius: 10px;
    margin-bottom: 2rem;
    text-align: center;
}
.score-header h1 {
    font-size: 3rem;
    margin: 0;
}
.score-header p {
    margin: 0.5rem 0 0 0;
    opacity: 0.9;
}
.metrics {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
    margin-bottom: 2rem;
}
.metric {
    background: #f5f5f5;
    padding: 1rem;
    border-radius: 5px;
}
.metric-label {
    color: #666;
    font-size: 0.9rem;
    margin-bottom: 0.5rem;
}
.metric-value {
    font-size: 1.5rem;
    font-weight: bold;
    color: #333;
}
.checkpoint-table {
    overflow-x: auto;
}
.penalty-breakdown {
    overflow-x: auto;
    margin-bottom: 2rem;
}
.penalty-breakdown table {
    width: 100%;
    border-collapse: collapse;
    border: 1px solid #ddd;
}
.penalty-breakdown th,
.penalty-breakdown td {
    padding: 10px;
    text-align: right;
    border: 1px solid #ddd;
}
.penalty-breakdown th {
    background: #333;
    color: white;
    font-weight: bold;
}
.penalty-breakdown td:first-child,
.penalty-breakdown th:first-child {
    text-align: left;
}
.penalty-breakdown tr[style*="background: #f0f0f0"] {
    background: #f0f0f0 !important;
    font-weight: bold;
}
.penalty-breakdown tr[style*="background: #e8e8e8"] {
    background: #e8e8e8 !important;
    font-weight: bold;
}
.penalty-breakdown tr[style*="background: #d0d0d0"] {
    background: #d0d0d0 !important;
    font-weight: bold;
}
.penalty-breakdown tr[style*="background: #8B0015"] {
    background: #8B0015 !important;
    color: white;
    font-weight: bold;
    font-size: 1.1rem;
}
</style>
{% endblock %}

{% block content %}
<div class="score-header">
    <h1>{{ result.overall_score|round(0) }} pts</h1>
    <p>{{ nav.name }} - {{ result.scored_at }}</p>
</div>

<h3>Penalty Breakdown</h3>
<div class="penalty-breakdown">
    <table>
        <thead>
            <tr>
                <th>Category</th>
                <th>Estimate</th>
                <th>Actual</th>
                <th>Deviation</th>
                <th>Points</th>
            </tr>
        </thead>
        <tbody>
            <!-- TIMING PENALTIES -->
            <tr style="background: #f0f0f0; font-weight: bold;">
                <td colspan="5">TIMING PENALTIES</td>
            </tr>
            {% for cp in result.checkpoint_results %}
            <tr>
                <td>Leg {{ loop.index }}: {{ cp.name }}</td>
                <td>{{ cp.estimated_time|format_time }}</td>
                <td>{{ cp.actual_time|format_time }}</td>
                <td>{{ cp.deviation|format_signed }}s</td>
                <td>{{ cp.leg_score|round(0) }} pts</td>
            </tr>
            {% endfor %}
            <tr style="background: #e8e8e8; font-weight: bold;">
                <td colspan="4">Subtotal: Leg Penalties</td>
                <td>{{ result.leg_penalties|round(0) }} pts</td>
            </tr>
            <tr>
                <td style="font-weight: bold;">Total Time</td>
                <td>{{ result.estimated_total_time|format_time }}</td>
                <td>{{ result.actual_total_time|format_time }}</td>
                <td>{{ result.total_time_deviation|format_signed }}s</td>
                <td>{{ result.total_time_penalty|round(0) }} pts</td>
            </tr>
            <tr style="background: #d0d0d0; font-weight: bold;">
                <td colspan="4">TIMING SUBTOTAL</td>
                <td>{{ result.total_time_score|round(0) }} pts</td>
            </tr>
            
            <!-- OFF-COURSE PENALTIES -->
            <tr style="background: #f0f0f0; font-weight: bold;">
                <td colspan="5">OFF-COURSE PENALTIES</td>
            </tr>
            {% for cp in result.checkpoint_results %}
            <tr>
                <td>{{ cp.name }}</td>
                <td>Within {{ result.checkpoint_radius|default('0.25') }} NM</td>
                <td>{{ cp.distance_nm|round(3) }} NM</td>
                <td>
                    {% if cp.within_0_25_nm %}
                        <span style="color: green;">✓ Inside</span>
                    {% else %}
                        <span style="color: orange;">{{ (cp.distance_nm - result.checkpoint_radius|default(0.25))|round(3) }} NM over</span>
                    {% endif %}
                </td>
                <td>{{ cp.off_course_penalty|round(0) }} pts</td>
            </tr>
            {% endfor %}
            <tr style="background: #d0d0d0; font-weight: bold;">
                <td colspan="4">Subtotal: Off-Course</td>
                <td>{{ result.total_off_course|round(0) }} pts</td>
            </tr>
            
            <!-- FUEL PENALTY -->
            <tr style="background: #f0f0f0; font-weight: bold;">
                <td colspan="5">FUEL PENALTY</td>
            </tr>
            <tr>
                <td>Fuel Burn</td>
                <td>{{ result.estimated_fuel_burn }} gal</td>
                <td>{{ result.actual_fuel_burn }} gal</td>
                <td>{{ (result.actual_fuel_burn - result.estimated_fuel_burn)|round(2) }} gal ({{ result.fuel_error_pct|round(1) }}%)</td>
                <td>{{ result.fuel_penalty|round(0) }} pts</td>
            </tr>
            
            <!-- SECRETS PENALTIES -->
            <tr style="background: #f0f0f0; font-weight: bold;">
                <td colspan="5">SECRETS PENALTIES</td>
            </tr>
            <tr>
                <td>Checkpoint secrets missed</td>
                <td>-</td>
                <td>{{ result.secrets_missed_checkpoint }}</td>
                <td>-</td>
                <td>{{ result.checkpoint_secrets_penalty|round(0) }} pts</td>
            </tr>
            <tr>
                <td>Enroute secrets missed</td>
                <td>-</td>
                <td>{{ result.secrets_missed_enroute }}</td>
                <td>-</td>
                <td>{{ result.enroute_secrets_penalty|round(0) }} pts</td>
            </tr>
            <tr style="background: #d0d0d0; font-weight: bold;">
                <td colspan="4">Subtotal: Secrets</td>
                <td>{{ (result.checkpoint_secrets_penalty + result.enroute_secrets_penalty)|round(0) }} pts</td>
            </tr>
            
            <!-- OVERALL -->
            <tr style="background: #8B0015; color: white; font-weight: bold; font-size: 1.1rem;">
                <td colspan="4">OVERALL SCORE</td>
                <td>{{ result.overall_score|round(0) }} pts</td>
            </tr>
        </tbody>
    </table>
</div>

<h3>Checkpoint Details</h3>
<div class="checkpoint-table">
    <table>
        <thead>
            <tr>
                <th>Checkpoint</th>
                <th>Method</th>
                <th>Distance (NM)</th>
                <th>Time Dev (s)</th>
                <th>Leg Score</th>
                <th>Off-Course</th>
            </tr>
        </thead>
        <tbody>
            {% for cp in result.checkpoint_results %}
            <tr>
                <td>{{ cp.name }}</td>
                <td>
                    {% if cp.within_0_25_nm %}
                        <span style="color: green;">{{ cp.method }}</span>
                    {% else %}
                        <span style="color: orange;">{{ cp.method }}</span>
                    {% endif %}
                </td>
                <td>{{ cp.distance_nm|round(3) }}</td>
                <td>{{ cp.deviation|round(0) }}</td>
                <td>{{ cp.leg_score|round(0) }} pts</td>
                <td>{{ cp.off_course_penalty|round(0) }} pts</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<h3>Fuel Summary</h3>
<table>
    <tr>
        <td><strong>Estimated:</strong></td>
        <td>{{ result.estimated_fuel_burn }} gal</td>
    </tr>
    <tr>
        <td><strong>Actual:</strong></td>
        <td>{{ result.actual_fuel_burn }} gal</td>
    </tr>
    <tr>
        <td><strong>Difference:</strong></td>
        <td>{{ (result.actual_fuel_burn - result.estimated_fuel_burn)|round(2) }} gal</td>
    </tr>
    <tr>
        <td><strong>Penalty:</strong></td>
        <td>{{ result.fuel_penalty|round(0) }} pts</td>
    </tr>
</table>

{% if result.pdf_filename %}
<div class="button-group" style="margin-top: 2rem;">
    <button onclick="window.location.href='/results/{{ result.id }}/pdf'">Download PDF Report</button>
    <button onclick="window.location.href='{{ dashboard_url|default('/team') }}'">Return to Dashboard</button>
</div>
{% else %}
<div class="button-group" style="margin-top: 2rem;">
    <button onclick="window.location.href='{{ dashboard_url|default('/team') }}'">Return to Dashboard</button>
</div>
{% endif %}

{% endblock %}
