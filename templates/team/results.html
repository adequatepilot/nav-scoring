{% extends "base.html" %}

{% block title %}Flight Results - NAV Scoring{% endblock %}

{% block navbar %}
<div class="navbar">
    <div class="navbar-brand">
        <button class="hamburger" id="hamburgerBtn">☰</button>
        <h1>NAV Scoring - Results</h1>
    </div>
    <div class="navbar-links" id="navbarLinks">
        <a href="/dashboard">Dashboard</a>
        <a href="/profile">Profile</a>
        <a href="/logout">Logout</a>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
.card {
    max-width: 1200px;
}
.score-header {
    background: linear-gradient(135deg, #B0B0B0 0%, #4A4A4A 100%);
    color: white;
    padding: 2rem;
    border-radius: 10px;
    margin-bottom: 2rem;
    text-align: center;
}
.score-header h1 {
    font-size: 3.5rem;
    margin: 0;
    color: white !important;
    font-weight: 700;
}
.score-header p {
    margin: 1rem 0 0 0;
    color: white !important;
    font-size: 1.25rem;
    font-weight: 500;
    opacity: 1;
}
.metrics {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
    margin-bottom: 2rem;
}
.metric {
    background: #f5f5f5;
    padding: 1rem;
    border-radius: 5px;
}
.metric-label {
    color: #666;
    font-size: 0.9rem;
    margin-bottom: 0.5rem;
}
.metric-value {
    font-size: 1.5rem;
    font-weight: bold;
    color: #333;
}
.penalty-breakdown {
    overflow-x: auto;
    margin-bottom: 2rem;
    -webkit-overflow-scrolling: touch;
}
.penalty-breakdown table {
    width: 100%;
    border-collapse: collapse;
    border: 1px solid #ddd;
    font-size: 0.95rem;
}
.penalty-breakdown th,
.penalty-breakdown td {
    padding: 10px;
    text-align: right;
    border: 1px solid #ddd;
    white-space: nowrap;
}
.penalty-breakdown th {
    background: #333;
    color: white;
    font-weight: bold;
    padding: 12px 10px;
}
.penalty-breakdown td:first-child,
.penalty-breakdown th:first-child {
    text-align: left;
    white-space: normal;
    min-width: 140px;
}
.penalty-breakdown thead tr:first-child th {
    background: #f0f0f0;
    color: #333;
    font-weight: bold;
    text-align: left;
    padding: 12px 10px;
}
.penalty-breakdown tbody tr:nth-child(2) th:first-child {
    background: #333;
    color: white;
}
.penalty-breakdown tbody tr:nth-child(2) th {
    background: #333;
    color: white;
    text-align: right;
}

/* Mobile responsiveness */
@media (max-width: 768px) {
    .penalty-breakdown table {
        font-size: 0.85rem;
    }
    .penalty-breakdown th,
    .penalty-breakdown td {
        padding: 8px 5px;
    }
    .penalty-breakdown td:first-child,
    .penalty-breakdown th:first-child {
        min-width: 100px;
    }
    .score-header {
        padding: 1.5rem;
    }
    .score-header h1 {
        font-size: 2.5rem;
        margin: 0;
    }
    .score-header p {
        font-size: 1.1rem;
        margin: 0.75rem 0 0 0;
    }
}

@media (max-width: 480px) {
    .penalty-breakdown table {
        font-size: 0.75rem;
    }
    .penalty-breakdown th,
    .penalty-breakdown td {
        padding: 6px 3px;
    }
    .card {
        max-width: 100%;
    }
    .score-header {
        padding: 1rem;
        margin-bottom: 1.5rem;
    }
    .score-header h1 {
        font-size: 2rem;
        margin: 0;
    }
    .score-header p {
        font-size: 0.95rem;
        margin: 0.5rem 0 0 0;
    }
}
</style>
{% endblock %}

{% block content %}
<div class="score-header">
    <h1>{{ result.overall_score|round(0) }} pts</h1>
    <p>{{ nav.name }} - <strong>Flight Started:</strong> {{ result.flight_started_at }}</p>
    {% if pairing %}
    <div style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid rgba(255,255,255,0.3); font-size: 1rem;">
        <strong>Pilot:</strong> {{ pairing.pilot_name }} | <strong>Observer:</strong> {{ pairing.observer_name }}
    </div>
    {% endif %}
</div>

<h3>Complete Results Summary</h3>
<div class="penalty-breakdown">
    <table>
        <thead>
            <tr style="background: #f0f0f0;">
                <th colspan="8" style="text-align: left; padding: 12px 10px; font-weight: bold;">TIMING PENALTIES</th>
            </tr>
            <tr>
                <th>Leg</th>
                <th>Estimated</th>
                <th>Actual</th>
                <th>Deviation</th>
                <th>Time Points</th>
                <th>Method</th>
                <th>Off Course (NM)</th>
                <th>Off Course Pts</th>
                <th>Total Points</th>
            </tr>
        </thead>
        <tbody>
            <!-- LEG ROWS -->
            {% for cp in result.checkpoint_results %}
            <tr>
                <td><strong>Leg {{ loop.index }}: {{ cp.name }}</strong></td>
                <td>{{ cp.estimated_time|format_time }}</td>
                <td>{{ cp.actual_time|format_time }}</td>
                <td>{{ cp.deviation|format_signed }}s</td>
                <td>{{ cp.leg_score|round(0) }} pts</td>
                <td>{{ cp.method }}</td>
                <td>
                    {% if cp.within_0_25_nm %}
                        <span style="color: green;">{{ cp.distance_nm|round(3) }} ✓</span>
                    {% else %}
                        <span style="color: orange;">{{ cp.distance_nm|round(3) }} ({{ (cp.distance_nm - result.checkpoint_radius|default(0.25))|round(3) }} over)</span>
                    {% endif %}
                </td>
                <td>{{ cp.off_course_penalty|round(0) }} pts</td>
                <td><strong>{{ (cp.leg_score + cp.off_course_penalty)|round(0) }} pts</strong></td>
            </tr>
            {% endfor %}
            
            <!-- TOTAL TIME ROW -->
            <tr style="background: #e8e8e8; font-weight: bold; border-top: 2px solid #333;">
                <td>Total Time</td>
                <td>{{ result.estimated_total_time|format_time }}</td>
                <td>{{ result.actual_total_time|format_time }}</td>
                <td>{{ result.total_time_deviation|format_signed }}s</td>
                <td>{{ result.total_time_penalty|round(0) }} pts</td>
                <td style="text-align: center;">—</td>
                <td colspan="2" style="text-align: center;">—</td>
                <td>{{ result.total_time_penalty|round(0) }} pts</td>
            </tr>
            
            <!-- TIMING SUBTOTAL -->
            <tr style="background: #d0d0d0; font-weight: bold;">
                <td colspan="8">TIMING SUBTOTAL</td>
                <td>{{ result.total_time_score|round(0) }} pts</td>
            </tr>
            
            <!-- ADDITIONAL PENALTIES SECTION -->
            <tr style="background: #f0f0f0; height: 8px;">
                <td colspan="9"></td>
            </tr>
            <tr style="background: #f0f0f0;">
                <th colspan="9" style="text-align: left; padding: 12px 10px; font-weight: bold;">ADDITIONAL PENALTIES</th>
            </tr>
            
            <!-- FUEL ROW -->
            <tr>
                <td><strong>Fuel Burn</strong></td>
                <td style="text-align: center;">—</td>
                <td>{{ result.estimated_fuel_burn|round(1) }} gal</td>
                <td>{{ result.actual_fuel_burn|round(1) }} gal</td>
                <td>{{ result.fuel_error_pct|round(1) }}%</td>
                <td colspan="3" style="text-align: center;">—</td>
                <td>{{ result.fuel_penalty|round(0) }} pts</td>
            </tr>
            
            <!-- CHECKPOINT SECRETS ROW -->
            <tr>
                <td><strong>Checkpoint Secrets Missed</strong></td>
                <td style="text-align: center;">—</td>
                <td colspan="2" style="text-align: center;">{{ result.secrets_missed_checkpoint }}</td>
                <td colspan="4" style="text-align: center;">—</td>
                <td>{{ result.checkpoint_secrets_penalty|round(0) }} pts</td>
            </tr>
            
            <!-- ENROUTE SECRETS ROW -->
            <tr>
                <td><strong>Enroute Secrets Missed</strong></td>
                <td style="text-align: center;">—</td>
                <td colspan="2" style="text-align: center;">{{ result.secrets_missed_enroute }}</td>
                <td colspan="4" style="text-align: center;">—</td>
                <td>{{ result.enroute_secrets_penalty|round(0) }} pts</td>
            </tr>
            
            <!-- OVERALL SCORE -->
            <tr style="background: #8B0015; color: white; font-weight: bold; font-size: 1.1rem; border-top: 2px solid #8B0015;">
                <td colspan="8">OVERALL SCORE</td>
                <td>{{ result.overall_score|round(0) }} pts</td>
            </tr>
        </tbody>
    </table>
</div>

{% if result.pdf_filename %}
<div class="button-group" style="margin-top: 2rem;">
    <button onclick="window.location.href='/results/{{ result.id }}/pdf'">Download PDF Report</button>
    <button onclick="window.location.href='{{ dashboard_url|default('/team') }}'">Return to Dashboard</button>
</div>
{% else %}
<div class="button-group" style="margin-top: 2rem;">
    <button onclick="window.location.href='{{ dashboard_url|default('/team') }}'">Return to Dashboard</button>
</div>
{% endif %}

{% endblock %}
